- name: Refresh SSH connection to pick up docker group membership
  meta: reset_connection

- name: Check if Docker directory exists
  ansible.builtin.stat:
    path: "{{ user_home }}/github_repo/dotfiles/docker_compose/{{ project_dir }}/{{ vm_type }}"
  register: compose_dir
  when: vm_type != 'dev'

- name: Run Docker Compose Pull (Only if missing)
  become: true
  become_user: "{{ ansible_user }}"
  shell:
    cmd: |
      for img in $(docker compose config --images); do
        if ! docker image inspect "$img" >/dev/null 2>&1; then
          docker pull "$img"
        fi
      done
    chdir: "{{ user_home }}/github_repo/dotfiles/docker_compose/{{ project_dir }}/{{ vm_type }}"
  register: docker_out
  async: 3600  # Increased to 1 hour for large media images
  poll: 30    # Check every 30s to reduce terminal spam
  # Only run if it's not the dev machine AND the directory exists
  when: 
    - vm_type != 'dev'
    - compose_dir.stat is defined
    - compose_dir.stat.exists

- name: Show Docker Results
  debug:
    msg: "{{ (docker_out.stderr_lines | default([])) + (docker_out.stdout_lines | default([])) }}"
  # This check is safer: it checks if the key 'skipped' exists AND is true
  when: 
    - docker_out is defined
    - docker_out.skipped is not defined or not docker_out.skipped
