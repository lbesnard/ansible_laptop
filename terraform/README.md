# üöÄ Homelab: Provisioning & Setup

This part of the repository contains the Infrastructure as Code (IaC) to provision Proxmox VMs via Terraform and configure them using Ansible.

---

## üèÅ 0. Starting a New Project

If you are setting up a new environment or node type, start by copying the existing **Brownfunk** configuration into a new working directory:

```bash
# Example: Creating a new environment based on the brownfunk baseline
cp -r brownfunk myNewNode
cd myNewNode
```

---

## üõ†Ô∏è 1. Infrastructure (Terraform)

Terraform handles the VM hardware creation on Proxmox and dynamically generates the Ansible inventory.

### Configuration (`terraform.tfvars`)

Create a `terraform.tfvars` file. This file stores your unique credentials and is ignored by Git.

```hcl
pm_api_url   = "https://192.168.8.x:8006/"
pm_api_token = "terraform-user@pve!provisionertoken"
ssh_key      = "ssh-rsa AAAAB3Nza... user@laptop"
```

### Defining the Fleet (`variables.tf`)

The `vm_fleet` map in `variables.tf` is the **Source of Truth** for your hardware.  
To add a node, add an entry to the `default` block of the `vm_fleet` variable.

**Note:** The name (e.g., `bf-media`) is used by the inventory template to assign Ansible groups.

**Note**: 4 VMs are created [nas, net, media, dev]


```hcl
variable "vm_fleet" {
  type = map(object({
    id        = number
    ip        = string
    cores     = number
    memory    = number
    disk_size = number
  }))
  default = {
    "bf-nas"   = { id = 181, ip = "192.168.8.181", cores = 1, memory = 1024, disk_size = 10 }
    "bf-media" = { id = 182, ip = "192.168.8.182", cores = 4, memory = 8192, disk_size = 100 }
    # Add your new node here:
    "bf-new-01"   = { id = 185, ip = "192.168.8.185", cores = 2, memory = 4096, disk_size = 40 }
  }
}
```

### Provisioning

```bash
terraform init
terraform apply
```

---

## üìÇ 2. Ansible Inventory

When `terraform apply` finishes, it automatically generates a `myNewNode.ini`-style file under  `ansible/inventory` in your root directory.

This file is built using `inventory.tftpl` and maps your VMs into groups like:

- `[nas_servers]`
- `[media_servers]`
- `[dev_servers]`

---

## ‚öôÔ∏è 3. Configuration (Ansible)

Once the VMs are **running**, use Ansible to provision the VMs.

### Prerequisites

Install the required collections:

```bash
cd ansible/
ansible-galaxy collection install -r requirements.yml -p ./collections
```

### Execution

Run the master playbook using the inventory generated by Terraform:

```bash
ansible-playbook -i inventory/myNewNode.ini setup_homelabs.yml 
```

