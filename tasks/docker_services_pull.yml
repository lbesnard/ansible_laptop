- name: Refresh SSH connection to pick up docker group membership
  meta: reset_connection

- name: Run Docker Compose Pull (Only if missing)
  become: true
  become_user: "{{ ansible_user }}"
  shell:
    cmd: |
      for img in $(docker compose config --images); do
        if ! docker image inspect "$img" >/dev/null 2>&1; then
          docker pull "$img"
        fi
      done
    chdir: "{{ user_home }}/github_repo/dotfiles/docker_compose/{{ project_dir }}/{{ vm_type }}"
  register: docker_out
  async: 1800
  poll: 10

- name: Show Docker Results
  debug:
    msg: "{{ docker_out.stderr_lines + docker_out.stdout_lines }}"
